# This workflow will perform a diff between selfacare openapi saved locally and remote.

name: 'Diff openapi selfcare'

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:
  push:

jobs:
  diff_json:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      # Exit with error if SLACK_WEBHOOK_URL is not set
      - name: Check Slack Webhook
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set. Please set the secret."
            exit 1
          fi

      - name: Check out current repo
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab #v3.5.2
        with:
          fetch-depth: 2

      - name: Download remote selfcare openapi JSON
        run: |
          curl -sSL https://selfcare.pagopa.it/developer/external/v2/ms-external-api.json -o openapi-selfcare-remote.json

      - name: Compare JSON files
        id: diff
        run: |
          jq --sort-keys . openapi-selfcare.json > openapi-selfcare-local-sorted.json
          jq --sort-keys . openapi-selfcare-remote.json > openapi-selfcare-remote-sorted.json

          echo "Confronto JSON openapi..."
          if ! diff -u openapi-selfcare-local-sorted.json openapi-selfcare-remote-sorted.json > diff_openapi_selfcare_output.txt; then
            echo "has_diff_openapi_selfcare=true" >> $GITHUB_OUTPUT
            echo "Differences found"
          else
            echo "has_diff_openapi_selfcare=false" >> $GITHUB_OUTPUT
            echo "Differences NOT found"
          fi

      - name: Debug output
        run: |
            echo "OUTPUT: '${{ steps.diff.outputs.has_diff_openapi_selfcare }}'"    

      - name: Upload diff artifact
        if: steps.diff.outputs.has_diff_openapi_selfcare == true
        uses: actions/upload-artifact@v4
        with:
          name: diff-openapi-selfcare
          path: diff_openapi_selfcare_output.txt

      - name: Different openapi selfcare notification
        if: steps.diff.outputs.has_diff_openapi_selfcare == true
        id: diff_openapi_selfcare_notify
        uses: pagopa/dx/.github/actions/slack-notification@main
        with:
          id: 'Different openapi selfcare detected'
          title: ':x: Different openapi selfcare'
          text: 'Differences were found in openapi selfcare between local and remote version.\n Check the GHA output to see the differences.'
          slack_webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
