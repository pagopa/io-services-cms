openapi: 3.0.3
info:
  title: IO Services CMS
  description: |-
    _This is the IO Service CMS based on the OpenAPI 3.0 specification._

    ### Some useful links:
    - [IO-SERVICES-CMS Github codebase](https://github.com/pagopa/io-services-cms)
    - [IO-SERVICES-CMS Source API definition ](https://github.com/pagopa/io-services-cms/openapi.yaml)

  contact:
    name: PagoPA S.p.A.
    url: https://docs.pagopa.it/io-guida-tecnica/
  version: 0.11.0
servers:
  - url: https://url
tags:
  - name: services
    description: Services API specification
  - name: service-review
    description: Service Review API specification
  - name: service-release
    description: Service Release API specification
  - name: service-authorization
    description: Service Authorization API specification
paths:
  /info:
    get:
      description: Get runtime status information about the application
      operationId: info
      security: [] # public endpoint
      responses:
        '200':
          description: The application is up and running
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    description: the application version
                  name:
                    type: string
                    description: the application name
        '500':
          description: The fails to startup due to misconfiguration or unreachable dependencies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseError'
  /services:
    post:
      tags:
        - services
      summary: Create a new service
      description: Create a new Service with the attributes provided in the request payload
      operationId: createService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
      requestBody:
        description: A service body payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServicePayload'
        required: true
      responses:
        '201':
          description: Service created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceLifecycle'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    get:
      tags:
        - services
      summary: Retrieve all services
      description: Retrieve all services owned by the calling user
      operationId: getServices
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: limit
          in: query
          description: The number of services to return
          required: false
          schema:
            type: number
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: The number of services to skip before starting to collect the result set
          required: false
          schema:
            type: number
            minimum: 0
            default: 0
      responses:
        '200':
          description: Services fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicePagination'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}:
    get:
      tags:
        - services
      summary: Retrieve service
      description: Retrieve a service by ID
      operationId: getService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceLifecycle'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    put:
      tags:
        - services
      summary: Update service
      description: Update an existing service by ID
      operationId: updateService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      requestBody:
        description: Updated service payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServicePayload'
        required: true
      responses:
        '200':
          description: Service updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceLifecycle'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    delete:
      tags:
        - services
      summary: Delete service
      description: Delete a service by ID
      operationId: deleteService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Service deleted successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}/logo:
    put:
      tags:
        - services
      summary: Upload service logo
      description: Upload service logo by service ID
      operationId: updateServiceLogo
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      requestBody:
        description: Service logo payload _(base64 string representation)_
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Logo'
        required: true
      responses:
        '204':
          description: Service logo updated successfully
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}/keys:
    get:
      tags:
        - service-authorization
      summary: Retrieve service keys
      description: Retrieve service keys by service ID
      operationId: getServiceKeys
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service keys fetched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionKeys'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}/keys/{keyType}:
    put:
      tags:
        - service-authorization
      summary: Regenerate service key
      description: Regenerate service key by service ID and key type
      operationId: regenerateServiceKey
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
        - name: keyType
          in: path
          description: Key type
          required: true
          schema:
            $ref: '#/components/schemas/SubscriptionKeyType'
      responses:
        '200':
          description: Service key regenerated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionKeys'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}/review:
    put:
      tags:
        - service-review
      summary: Send service to review
      description: Send service to review by service ID
      operationId: reviewService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      requestBody:
        description: Review Request option
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewRequest'
        required: true
      responses:
        '204':
          description: Service revirew taken in charge
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '409':
          description: Service status is incompatible with review action request
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    patch:
      tags:
        - service-review
      summary: Explain service review
      description: Explain service review by service ID
      operationId: explainService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      requestBody:
        description: An explanation comment
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Comment'
        required: true
      responses:
        '204':
          description: Service explained successfully
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '409':
          description: Service status is incompatible with explain action request
        '429':
          description: Too many requests
        '500':
          description: Internal server error
  /services/{serviceId}/release:
    post:
      tags:
        - service-release
      summary: Publish service on IO
      description: Publish service by ID on __IO Platform__
      operationId: releaseService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Service published successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '409':
          description: Service status is incompatible with publish action request
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    get:
      tags:
        - service-release
      summary: Retrieve last published version of service
      description: Retrieve last version of service published on __IO Platform__
      operationId: getPublishedService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Fetched published service
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicePublication'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
    delete:
      tags:
        - service-release
      summary: Unpublish service from IO
      description: Unpublish service by ID from __IO Platform__
      operationId: unpublishService
      parameters:
        - $ref: '#/components/parameters/UserEmail'
        - $ref: '#/components/parameters/UserGroups'
        - $ref: '#/components/parameters/UserID'
        - $ref: '#/components/parameters/SubscriptionID'
        - name: serviceId
          in: path
          description: ID of the service
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Service unpublished successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '429':
          description: Too many requests
        '500':
          description: Internal server error
components:
  parameters:
    UserEmail:
      in: header
      name: x-user-email
      required: true
      schema:
        type: string
    UserGroups:
      in: header
      name: x-user-groups
      required: true
      schema:
        type: string
    UserID:
      in: header
      name: x-user-id
      required: true
      schema:
        type: string
    SubscriptionID:
      in: header
      name: x-subscription-id
      required: true
      schema:
        type: string
  schemas:
    ServiceLifecycle:
      description: Service Lifecycle model data
      allOf:
        - type: object
          properties:
            id:
              type: string
            status:
              $ref: '#/components/schemas/ServiceLifecycleStatus'
            version:
              type: integer
            last_update:
              $ref: '#/components/schemas/Timestamp'
          required:
            - id
            - status
            - last_update
        - $ref: '#/components/schemas/ServiceData'
    ServicePublication:
      description: Service Publication model data
      allOf:
        - type: object
          properties:
            id:
              type: string
            status:
              $ref: '#/components/schemas/ServicePublicationStatusType'
            version:
              type: integer
            last_update:
              $ref: '#/components/schemas/Timestamp'
          required:
            - id
            - status
            - last_update
        - $ref: '#/components/schemas/ServiceData'
    ServicePayload:
      description: A payload used to create or update a service.
      allOf:
        - $ref: '#/components/schemas/ServiceData'
    ServiceData:
      type: object
      description: Service basic data
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
          minLength: 1
        organization:
          $ref: '#/components/schemas/Organization'
        require_secure_channel:
          type: boolean
        authorized_recipients:
          type: array
          items:
            $ref: '#/components/schemas/FiscalCode'
        authorized_cidrs:
          description: >-
            Allowed source IPs or CIDRs for this service.

            When empty, every IP address it's authorized to call the IO API on
            behalf of the service.
          type: array
          items:
            $ref: '#/components/schemas/Cidr'
        max_allowed_payment_amount:
          type: integer
          format: int32
          minimum: 0
          maximum: 9999999999
          default: 0
        metadata:
          $ref: '#/components/schemas/ServiceMetadata'
      required:
        - name
        - description
        - organization
        - metadata
    ServiceMetadata:
      type: object
      description: A set of service metadata properties
      properties:
        web_url:
          type: string
          minLength: 1
        app_ios:
          type: string
          minLength: 1
        app_android:
          type: string
          minLength: 1
        tos_url:
          type: string
          minLength: 1
        privacy_url:
          type: string
          minLength: 1
        address:
          type: string
          minLength: 1
        phone:
          type: string
          minLength: 1
        email:
          type: string
          minLength: 1
        pec:
          type: string
          minLength: 1
        cta:
          type: string
          minLength: 1
        token_name:
          type: string
          minLength: 1
        support_url:
          type: string
          minLength: 1
        category:
          type: string
          enum: [SPECIAL, STANDARD]
        custom_special_flow:
          type: string
          minLength: 1
        scope:
          type: string
          enum: [NATIONAL, LOCAL]
      required:
        - scope
    ServiceLifecycleStatus:
      type: object
      properties:
        value:
          $ref: '#/components/schemas/ServiceLifecycleStatusType'
        reason:
          description: Reason for status value
          type: string
      required:
        - value
    ServiceLifecycleStatusType:
      description: |
        Service lifecycle status<br>
        - _draft_: A new draft of the service has been created, filled in completely or partially and saved by the system.
        - _submitted_: The draft has been sent for internal validation to PagoPA and the response is awaited. In this state, the service is
        immutable and is frozen in the shipped version.
        - _approved_: The service has been approved by the _PagoPA S.p.A._ internal validation process, it is correct and suitable for publication.
        - _rejected_: The service goes back to the draft but cannot be resubmitted for validation unless it is modified by the institution in
        at least one of its fields.
        - _deleted_: The service is permanently deleted from the Back-Office.
      type: string
      enum: [draft, submitted, approved, rejected, deleted]
    ServicePublicationStatusType:
      description: |
        Service publication status<br>
        - _published_: The service is visible in _IO App_ to users
        - _unpublished_: The service is no longer visible in _IO App_ to users, but remains in the institution's Back-Office, which can
        later choose to publish it again.
      type: string
      enum: [published, unpublished]
    ServicePagination:
      type: object
      properties:
        value:
          type: array
          items:
            $ref: '#/components/schemas/ServiceLifecycle'
        pagination:
          $ref: '#/components/schemas/PaginationResultSet'
    PaginationResultSet:
      type: object
      properties:
        offset:
          type: number
          description: result set offset
        limit:
          type: number
          description: result set size
        count:
          type: number
          description: total record count
    Organization:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        fiscal_code:
          $ref: '#/components/schemas/OrganizationFiscalCode'
        department_name:
          type: string
          minLength: 1
      required:
        - name
        - fiscal_code
    OrganizationFiscalCode:
      type: string
      description: Organization's fiscal code.
      pattern: '^[0-9]{11}$'
      example: 012345678901
    FiscalCode:
      type: string
      description: User's fiscal code.
      pattern: '^[A-Z]{6}[0-9LMNPQRSTUV]{2}[ABCDEHLMPRST][0-9LMNPQRSTUV]{2}[A-Z][0-9LMNPQRSTUV]{3}[A-Z]$'
      example: AAAAAA00A00A000A
    Logo:
      description: A base64 string representation of the logo PNG image.
      type: object
      properties:
        logo:
          type: string
          format: byte
          minLength: 1
      required:
        - logo
    SubscriptionKeys:
      type: object
      properties:
        primary_key:
          type: string
        secondary_key:
          type: string
      required:
        - primary_key
        - secondary_key
    SubscriptionKeyType:
      type: string
      enum: [primary, secondary]
    Cidr:
      type: string
      description: Describes a single IP or a range of IPs.
      pattern: ^([0-9]{1,3}[.]){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))?$
    ResponseError:
      type: object
      properties:
        type:
          type: string
          format: uri
          description: |-
            An absolute URI that identifies the problem type. When dereferenced,
            it SHOULD provide human-readable documentation for the problem type
            (e.g., using HTML).
          default: about:blank
          example: https://example.com/problem/constraint-violation
        title:
          type: string
          description: |
            A short summary of the problem type. Written in english and readable for engineers.
            <br>_(usually not suited for non technical stakeholders and not localized)._
          example: Service Unavailable
        status:
          type: integer
          format: int32
          description: |
            The HTTP status code generated by the origin server for this occurrence of the problem.
          minimum: 100
          maximum: 600
          exclusiveMaximum: true
          example: 200
        detail:
          type: string
          description: |
            A human readable explanation specific to this occurrence of the problem.
          example: There was an error processing the request
        instance:
          type: string
          format: uri
          description: |
            An absolute URI that identifies the specific occurrence of the problem.
            It may or may not yield further information if dereferenced.
    Comment:
      type: object
      properties:
        comment:
          type: string
          example: This is an explanation comment
    ReviewRequest:
      type: object
      properties:
        auto_publish:
          type: boolean
          description: Flag to request an automatic service publication on service approval.
          example: true
      required:
        - auto_publish
    Timestamp:
      type: string
      description: A date-time field in ISO-8601 format and UTC timezone.
      example: '2023-01-22T00:00:00.000Z'
